<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agendamento - El Negrones</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #c5a059; --bg: #0f0f0f; --card: #181818; --input-bg: #222222; --text: #f0f0f0; --danger: #ff4757; --whatsapp: #25d366; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 450px; margin: auto; }
        .header { text-align: center; padding: 30px 0; }
        .header h1 { font-weight: 900; color: var(--primary); letter-spacing: 4px; }
        .card { background: var(--card); padding: 25px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.05); }
        label { font-size: 0.75rem; color: var(--primary); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; display: block; }
        input, select { width: 100%; padding: 16px; margin-bottom: 20px; border-radius: 15px; border: 1px solid #333; background: var(--input-bg); color: #fff; font-size: 1rem; outline: none; }
        .horarios-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
        .hora-btn { background: #252525; padding: 14px 5px; text-align: center; border-radius: 12px; border: 1px solid #333; cursor: pointer; }
        .hora-btn.selecionada { background: var(--primary); color: #000; font-weight: bold; }
        .hora-btn.ocupada { opacity: 0.1; text-decoration: line-through; pointer-events: none; }
        .btn-principal { width: 100%; padding: 20px; border-radius: 18px; background: var(--primary); color: #000; font-weight: 800; border: none; cursor: pointer; text-transform: uppercase; }
        .btn-whatsapp { background: var(--whatsapp); color: white; margin-top: 10px; }
        #bloqueio-total { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body>

<div id="bloqueio-total">
    <div style="padding: 30px;">
        <div style="font-size: 60px;">üîí</div>
        <h2 style="color: var(--primary)">SISTEMA EM MANUTEN√á√ÉO</h2>
        <p>O agendamento online retornar√° em breve.</p>
    </div>
</div>

<div class="container">
    <div class="header"><h1>‚úÇ EL NEGRONES</h1></div>
    <div class="card">
        <label>1. Profissional</label>
        <select id="select-barbeiro" onchange="atualizarServicos()"><option value="">Carregando...</option></select>
        <label>2. Servi√ßo</label>
        <select id="select-servico"><option value="">Escolha o profissional primeiro</option></select>
        <label>3. Data</label>
        <input type="date" id="data-agenda" onchange="verificarDataEGerar()">
        
        <div id="area-indisponivel" style="display:none; text-align:center; margin-bottom:20px;">
            <div id="msg-data" style="color:var(--danger); font-size:0.8rem; margin-bottom:10px;">‚ö†Ô∏è Sem hor√°rios dispon√≠veis para esta data.</div>
            <button class="btn-principal btn-whatsapp" onclick="contatarBarbeiro()">Chamar no WhatsApp</button>
        </div>

        <label>4. Escolha o Hor√°rio</label>
        <div class="horarios-grid" id="grid-horarios"></div>
        <label>5. Seu Nome</label>
        <input type="text" id="nome-cliente" placeholder="Digite seu nome completo">
        <button class="btn-principal" onclick="confirmarAgendamento()">Finalizar Agendamento</button>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyC0x8q1N7R70BYhfd2daedBjRKH0qupJiI",
        authDomain: "elnes-720ce.firebaseapp.com",
        projectId: "elnes-720ce",
        storageBucket: "elnes-720ce.firebasestorage.app",
        messagingSenderId: "839018097076",
        appId: "1:839018097076:web:cc902e9081e3a35cac2ae1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let barbeirosData = [];
    let horarioSelecionado = null;

    window.onload = async () => {
        const config = await db.collection("configuracao").doc("assinatura").get();
        if (config.exists && config.data().premiumAte) {
            if (new Date() > config.data().premiumAte.toDate()) {
                document.getElementById("bloqueio-total").style.display = "flex";
                return;
            }
        }
        carregarBarbeiros();
        document.getElementById('data-agenda').value = new Date().toISOString().split("T")[0];
    };

    async function carregarBarbeiros() {
        const snap = await db.collection("barbeiros").get();
        barbeirosData = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const sB = document.getElementById("select-barbeiro");
        sB.innerHTML = '<option value="">Selecione o Barbeiro</option>';
        barbeirosData.forEach(b => sB.innerHTML += `<option value="${b.id}">${b.nome}</option>`);
    }

    function atualizarServicos() {
        const b = barbeirosData.find(x => x.id === document.getElementById("select-barbeiro").value);
        const sS = document.getElementById("select-servico");
        sS.innerHTML = '<option value="">Selecione o Servi√ßo</option>';
        if(b && b.servicos) b.servicos.split('\n').forEach(s => sS.innerHTML += `<option>${s}</option>`);
        verificarDataEGerar();
    }

    async function verificarDataEGerar() {
        const bId = document.getElementById("select-barbeiro").value;
        const data = document.getElementById("data-agenda").value;
        if(!bId || !data) return;
        const lock = await db.collection("bloqueios").where("barbeiroId", "==", bId).where("data", "==", data).where("hora", "==", "DIA_TODO").get();
        if(!lock.empty) {
            document.getElementById("grid-horarios").innerHTML = "";
            document.getElementById("area-indisponivel").style.display = "block";
        } else {
            document.getElementById("area-indisponivel").style.display = "none";
            gerarHorarios();
        }
    }

    async function gerarHorarios() {
        const data = document.getElementById("data-agenda").value;
        const bId = document.getElementById("select-barbeiro").value;
        const agSnap = await db.collection("agenda").where("data", "==", data).where("barbeiroId", "==", bId).get();
        const blSnap = await db.collection("bloqueios").where("data", "==", data).where("barbeiroId", "==", bId).get();
        const ocupados = [...agSnap.docs.map(d => d.data().hora), ...blSnap.docs.map(d => d.data().hora)];
        
        const grid = document.getElementById("grid-horarios");
        grid.innerHTML = "";
        let livres = 0;
        for(let h=9; h<20; h++) {
            ["00", "30"].forEach(m => {
                const hora = `${h.toString().padStart(2, '0')}:${m}`;
                const isOcupado = ocupados.includes(hora);
                if(!isOcupado) livres++;
                const div = document.createElement("div");
                div.className = "hora-btn " + (isOcupado ? "ocupada" : "");
                div.textContent = hora;
                div.onclick = () => {
                    document.querySelectorAll(".hora-btn").forEach(e => e.classList.remove("selecionada"));
                    div.classList.add("selecionada");
                    horarioSelecionado = hora;
                };
                grid.appendChild(div);
            });
        }
        if(livres === 0) document.getElementById("area-indisponivel").style.display = "block";
    }

    function contatarBarbeiro() {
        const b = barbeirosData.find(x => x.id === document.getElementById("select-barbeiro").value);
        if(b && b.whatsapp) {
            const msg = encodeURIComponent(`Ol√° ${b.nome}, gostaria de ver um hor√°rio por fora para o dia ${document.getElementById('data-agenda').value}`);
            window.open(`https://wa.me/55${b.whatsapp}?text=${msg}`);
        }
    }

    async function confirmarAgendamento() {
        const nome = document.getElementById("nome-cliente").value;
        const bId = document.getElementById("select-barbeiro").value;
        const bNome = document.getElementById("select-barbeiro").options[document.getElementById("select-barbeiro").selectedIndex].text;
        const data = document.getElementById("data-agenda").value;
        const serv = document.getElementById("select-servico").value;
        if(!nome || !horarioSelecionado || !bId) return alert("Preencha todos os campos!");
        await db.collection("agenda").add({ cliente: nome, barbeiroId: bId, barbeiroNome: bNome, data: data, hora: horarioSelecionado, servico: serv });
        alert("Agendamento realizado com sucesso!");
        location.reload();
    }
</script>
</body>
</html>
